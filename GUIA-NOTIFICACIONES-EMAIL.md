# üìß GU√çA COMPLETA: NOTIFICACIONES POR EMAIL

## üéØ OBJETIVO

Recibir un email autom√°tico a `ventas@mareuy.com` cada vez que llegue un nuevo pedido desde el cat√°logo MAR√â.

---

## üìã OPCIONES DISPONIBLES

He preparado **3 opciones** ordenadas de m√°s f√°cil a m√°s compleja:

### ‚úÖ **OPCI√ìN 1: Make.com / Zapier** (RECOMENDADA - LA M√ÅS F√ÅCIL)
- ‚è±Ô∏è Configuraci√≥n: 10-15 minutos
- üí∞ Costo: **GRATIS** (hasta 1,000 operaciones/mes en Make.com)
- üéØ Dificultad: **F√ÅCIL** (sin programaci√≥n)
- ‚úÖ Ideal para: Usuarios sin conocimientos t√©cnicos

### ‚úÖ **OPCI√ìN 2: Script Node.js Autom√°tico**
- ‚è±Ô∏è Configuraci√≥n: 20-30 minutos
- üí∞ Costo: **GRATIS**
- üéØ Dificultad: **MEDIA** (requiere configurar Gmail/SMTP)
- ‚úÖ Ideal para: Si tienes un servidor o computadora siempre encendida

### ‚úÖ **OPCI√ìN 3: Supabase Edge Function**
- ‚è±Ô∏è Configuraci√≥n: 30-45 minutos
- üí∞ Costo: **GRATIS** (incluido en Supabase)
- üéØ Dificultad: **AVANZADA** (requiere conocimientos de Supabase)
- ‚úÖ Ideal para: M√°xima confiabilidad y escalabilidad

---

## üöÄ PASO 1: PREPARAR LA BASE DE DATOS

### 1.1. Ejecutar el script SQL en Supabase

1. Ir a Supabase Dashboard: https://supabase.com/dashboard
2. Seleccionar tu proyecto
3. Ir a **SQL Editor** (en el men√∫ izquierdo)
4. Abrir el archivo `supabase-trigger-notificacion-email.sql`
5. Copiar TODO el contenido
6. Pegarlo en el SQL Editor
7. **IMPORTANTE**: Antes de ejecutar, editar estas l√≠neas:

```sql
-- L√≠nea 41: Cambiar el email de destino
'ventas@mareuy.com', -- üìß CAMBIAR ESTE EMAIL POR EL TUYO

-- L√≠nea 51: Cambiar la URL del ERP
'https://tu-erp.com/pedidos-recibidos', -- Cambiar por tu URL real
```

8. Hacer clic en **RUN** (o presionar Ctrl+Enter)
9. Verificar que aparezca: "Success. No rows returned"

### 1.2. Verificar que se cre√≥ correctamente

Ejecutar esta consulta en el SQL Editor:

```sql
SELECT * FROM notificaciones_pendientes LIMIT 1;
```

Deber√≠a aparecer una tabla vac√≠a (sin errores).

---

## ‚≠ê OPCI√ìN 1: CONFIGURAR CON MAKE.COM (RECOMENDADO)

### ‚úÖ Ventajas:
- No requiere programaci√≥n
- Interfaz visual (drag & drop)
- Gratis hasta 1,000 operaciones/mes
- Integraci√≥n directa con Gmail, Outlook, etc.
- Confiable y f√°cil de mantener

### üìù Paso a paso:

#### 1. Crear cuenta en Make.com

1. Ir a: https://www.make.com/en/register
2. Registrarse con tu email
3. Verificar el email
4. Elegir el plan **Free** (gratuito)

#### 2. Crear un nuevo escenario

1. Hacer clic en **"Create a new scenario"**
2. Buscar "Schedule" y agregarlo como primer m√≥dulo
3. Configurar:
   - **Interval**: 5 minutos
   - Esto har√° que el escenario se ejecute cada 5 minutos

#### 3. Agregar conexi√≥n con Supabase

1. Hacer clic en el **+** despu√©s del Schedule
2. Buscar "Supabase" y seleccionar **"Make an API Call"**
3. Conectar tu cuenta de Supabase:
   - **URL**: `https://cedspllucwvpoehlyccs.supabase.co`
   - **API Key**: `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNlZHNwbGx1Y3d2cG9laGx5Y2NzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2MjkyMTQsImV4cCI6MjA2ODIwNTIxNH0.80z7k6ti2pxBKb8x6NILe--YNaLhJemtC32oqKW-Kz4`

4. Configurar la llamada:
   - **Method**: POST
   - **URL**: `/rest/v1/rpc/obtener_notificaciones_pendientes`
   - **Headers**:
     ```
     Content-Type: application/json
     Prefer: return=representation
     ```

#### 4. Agregar filtro para verificar si hay notificaciones

1. Hacer clic en el **icono de llave inglesa** entre Supabase y el siguiente paso
2. Agregar condici√≥n:
   - **Label**: "Hay notificaciones"
   - **Condition**: `{{length(1.data)}}` greater than `0`

#### 5. Agregar iterador para procesar cada notificaci√≥n

1. Agregar m√≥dulo **"Iterator"**
2. Configurar:
   - **Array**: `{{1.data}}` (los datos de Supabase)

#### 6. Enviar email con Gmail/Outlook

**Para Gmail:**

1. Agregar m√≥dulo "Gmail" > "Send an Email"
2. Conectar tu cuenta de Gmail
3. Configurar:
   - **To**: `{{5.destinatario}}`
   - **Subject**: `{{5.asunto}}`
   - **Content Type**: HTML
   - **Text Content**:
   ```html
   <h2>üõí Nuevo Pedido Recibido</h2>
   <p><strong>N√∫mero:</strong> {{5.pedido_numero}}</p>
   <p><strong>Cliente:</strong> {{5.pedido_cliente}}</p>
   <p><strong>Total:</strong> ${{5.pedido_total}}</p>
   <br>
   <a href="http://localhost:5173/pedidos-recibidos">Ver en ERP</a>
   ```

**Para Outlook:**

1. Agregar m√≥dulo "Microsoft 365 Email" > "Send an Email"
2. Conectar tu cuenta de Microsoft
3. Configurar igual que Gmail

#### 7. Marcar notificaci√≥n como enviada

1. Agregar otro m√≥dulo de Supabase > "Make an API Call"
2. Configurar:
   - **Method**: POST
   - **URL**: `/rest/v1/rpc/marcar_notificacion_enviada`
   - **Body**:
   ```json
   {
     "notificacion_id": "{{5.id}}"
   }
   ```

#### 8. Activar el escenario

1. Hacer clic en el **switch ON/OFF** en la esquina inferior izquierda
2. Hacer clic en **"Run once"** para probar
3. Verificar que funcione correctamente

### üß™ Probar:

1. Crear un pedido de prueba desde el cat√°logo
2. Esperar 5 minutos (o ejecutar manualmente el escenario)
3. Verificar que llegue el email

---

## üîß OPCI√ìN 2: SCRIPT NODE.JS AUTOM√ÅTICO

### ‚úÖ Ventajas:
- Control total del c√≥digo
- Gratis (usa tu propio SMTP)
- Flexible y personalizable
- No depende de servicios externos

### üìù Paso a paso:

#### 1. Instalar dependencias

Abrir terminal en la carpeta del proyecto y ejecutar:

```bash
npm install @supabase/supabase-js nodemailer
```

#### 2. Configurar el script

1. Abrir el archivo `notificador-email.js`
2. Editar estas l√≠neas:

```javascript
// L√≠nea 20-26: Configurar tu email SMTP
const EMAIL_CONFIG = {
  host: 'smtp.gmail.com', // smtp.outlook.com para Outlook
  port: 587,
  secure: false,
  auth: {
    user: 'tu-email@gmail.com', // üìß CAMBIAR
    pass: 'tu-contrase√±a-app'    // üìß CAMBIAR (ver instrucciones abajo)
  }
};

// L√≠nea 29: Email de destino
const EMAIL_DESTINO = 'ventas@mareuy.com'; // üìß CAMBIAR
```

#### 3. Configurar Gmail para enviar emails

**Gmail requiere una "Contrase√±a de aplicaci√≥n":**

1. Ir a: https://myaccount.google.com/security
2. Activar **"Verificaci√≥n en 2 pasos"**
3. Buscar **"Contrase√±as de aplicaciones"**
4. Crear una nueva:
   - Nombre: "ERP Feraben Notificaciones"
   - Copiar la contrase√±a de 16 caracteres
5. Usar esa contrase√±a en `EMAIL_CONFIG.auth.pass`

**Para Outlook/Hotmail:**

```javascript
const EMAIL_CONFIG = {
  host: 'smtp-mail.outlook.com',
  port: 587,
  secure: false,
  auth: {
    user: 'tu-email@outlook.com',
    pass: 'tu-contrase√±a-normal' // Outlook usa la contrase√±a normal
  }
};
```

#### 4. Probar el script manualmente

```bash
node notificador-email.js
```

Deber√≠a aparecer:

```
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë   NOTIFICADOR DE EMAILS - ERP FERABEN    ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

üîß Verificando configuraci√≥n...

‚úÖ Conexi√≥n a Supabase: OK
‚úÖ Configuraci√≥n de email: OK

‚úÖ Todo configurado correctamente

[23/10/2025 14:30:45] üîç Buscando notificaciones pendientes...
‚úÖ No hay notificaciones pendientes

‚úÖ Proceso completado
```

#### 5. Ejecutar autom√°ticamente cada 5 minutos

**OPCI√ìN A: Con PM2 (Recomendado - Linux/Mac/Windows)**

```bash
# Instalar PM2 globalmente
npm install -g pm2

# Ejecutar el script cada 5 minutos
pm2 start notificador-email.js --cron "*/5 * * * *" --name "erp-notificaciones"

# Ver logs en tiempo real
pm2 logs erp-notificaciones

# Detener
pm2 stop erp-notificaciones

# Hacer que PM2 se inicie autom√°ticamente al reiniciar
pm2 startup
pm2 save
```

**OPCI√ìN B: Programador de tareas de Windows**

1. Abrir "Programador de tareas"
2. Crear tarea b√°sica > Nombre: "ERP Notificaciones"
3. Desencadenador: Diariamente, repetir cada 5 minutos
4. Acci√≥n: Iniciar programa
   - **Programa**: `C:\Program Files\nodejs\node.exe`
   - **Argumentos**: `C:\Users\Usuario\ERP-ferabensrl-claude\notificador-email.js`
5. Finalizar y probar

---

## üåê OPCI√ìN 3: SUPABASE EDGE FUNCTION (AVANZADO)

Esta opci√≥n requiere conocimientos avanzados de Supabase y Deno.

### üìù Paso a paso resumido:

1. Instalar Supabase CLI
2. Crear una Edge Function llamada `enviar-notificaciones`
3. Usar Resend API para enviar emails
4. Configurar un cron job para que se ejecute cada 5 minutos
5. Desplegar la funci√≥n

**Documentaci√≥n oficial:**
- https://supabase.com/docs/guides/functions
- https://resend.com/docs/send-with-supabase-functions

---

## üß™ PROBAR EL SISTEMA COMPLETO

### 1. Crear un pedido de prueba

1. Ir al cat√°logo MAR√â
2. Agregar productos al carrito
3. Enviar el pedido

### 2. Verificar que se cre√≥ la notificaci√≥n

En Supabase SQL Editor, ejecutar:

```sql
SELECT * FROM notificaciones_pendientes
ORDER BY created_at DESC
LIMIT 5;
```

Deber√≠a aparecer una notificaci√≥n con estado `pendiente`.

### 3. Esperar a que se env√≠e

- **Make.com**: Esperar 5 minutos o ejecutar manualmente
- **Script Node.js**: Esperar 5 minutos o ejecutar `node notificador-email.js`

### 4. Verificar que lleg√≥ el email

Revisar la bandeja de entrada de `ventas@mareuy.com`

### 5. Verificar que se marc√≥ como enviada

```sql
SELECT * FROM notificaciones_pendientes
WHERE estado = 'enviado'
ORDER BY enviado_en DESC
LIMIT 5;
```

---

## üìä MONITOREAR NOTIFICACIONES

### Ver historial completo:

```sql
SELECT
  id,
  tipo,
  destinatario,
  asunto,
  pedido_numero,
  estado,
  intentos,
  created_at,
  enviado_en
FROM notificaciones_pendientes
ORDER BY created_at DESC
LIMIT 20;
```

### Ver notificaciones con error:

```sql
SELECT * FROM notificaciones_pendientes
WHERE estado = 'error'
ORDER BY created_at DESC;
```

### Limpiar notificaciones antiguas (mensual):

```sql
DELETE FROM notificaciones_pendientes
WHERE estado = 'enviado'
AND enviado_en < NOW() - INTERVAL '30 days';
```

---

## üîß SOLUCI√ìN DE PROBLEMAS

### Problema: Las notificaciones no se crean

**Verificar que el trigger est√© activo:**

```sql
SELECT tgname, tgenabled
FROM pg_trigger
WHERE tgname = 'trigger_notificar_nuevo_pedido';
```

Deber√≠a aparecer `t` en `tgenabled`.

**Reactivar el trigger si es necesario:**

```sql
ALTER TABLE pedidos_recibidos
ENABLE TRIGGER trigger_notificar_nuevo_pedido;
```

### Problema: Los emails no se env√≠an (Script Node.js)

**1. Verificar configuraci√≥n de Gmail:**

```bash
node -e "
const nodemailer = require('nodemailer');
const transporter = nodemailer.createTransport({
  host: 'smtp.gmail.com',
  port: 587,
  secure: false,
  auth: {
    user: 'tu-email@gmail.com',
    pass: 'tu-contrase√±a-app'
  }
});
transporter.verify().then(() => console.log('‚úÖ OK')).catch(console.error);
"
```

**2. Error "Invalid login":**
- Verificar que est√©s usando una contrase√±a de aplicaci√≥n (no la contrase√±a normal)
- Verificar que la verificaci√≥n en 2 pasos est√© activada

**3. Error "Connection timeout":**
- Verificar firewall/antivirus
- Probar con otro puerto (465 con `secure: true`)

### Problema: Make.com no se ejecuta

1. Verificar que el escenario est√© **activado** (ON)
2. Revisar los logs en Make.com > History
3. Verificar que las credenciales de Supabase sean correctas
4. Probar ejecutar manualmente con "Run once"

---

## üí° RECOMENDACIONES

1. **Empezar con Make.com**: Es la opci√≥n m√°s f√°cil y confiable
2. **Probar con un email de prueba primero**: Antes de usar el email real de ventas
3. **Monitorear las primeras semanas**: Verificar que no haya errores
4. **Configurar l√≠mites**: En Make.com, configurar un m√°ximo de emails por d√≠a

---

## üìû SOPORTE

Si tienes problemas configurando las notificaciones:

1. Verificar los logs en Supabase
2. Probar ejecutar manualmente el script
3. Revisar la documentaci√≥n oficial de cada servicio

---

**‚úÖ Una vez configurado, el sistema funcionar√° autom√°ticamente:**

```
üì± Cliente env√≠a pedido ‚Üí üíæ Supabase guarda ‚Üí üîî Se crea notificaci√≥n
     ‚Üì
‚è∞ Cada 5 minutos ‚Üí üìß Se env√≠a email ‚Üí ‚úÖ Se marca como enviada
```

¬°Listo! üéâ
